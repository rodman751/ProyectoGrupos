@model CalendarViewModel

<div class="container-fluid">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h3>Calendario de @Model.GrupoNombre</h3>
            @if (ViewBag.EsAdministrador)
            {
                <a asp-controller="Actividades" asp-action="Index" asp-route-grupoId="@Model.GrupoId" class="btn btn-sm btn-secondary">
                    <i class="fas fa-cog"></i> Crear Actividad
                </a>


            }
        </div>
        <button id="prevMonthBtn">Mes Anterior</button>
        <button id="nextMonthBtn">Mes Siguiente</button>
        <div class="card-body">
            <div id="calendar" style="height: 600px;"></div>
        </div>
    </div>
</div>


<!-- Modal para Detalles del Evento -->
<div class="modal fade" id="eventDetailsModal" tabindex="-1" aria-labelledby="eventDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="eventDetailsTitle"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><strong>Descripción:</strong> <span id="eventDetailsDescription"></span></p>
                <p><strong>Fecha:</strong> <span id="eventDetailsDate"></span></p>
            </div>
            <div class="modal-footer">
                <!-- Botones de edición y eliminación dinámicamente generados -->
                <a id="editEventButton" class="btn btn-sm btn-secondary" href="#">
                    <i class="fas fa-cog"></i> Editar Actividad
                </a>
                <a id="deleteEventButton" class="btn btn-sm btn-danger" href="#">
                    <i class="fas fa-trash-alt"></i> Eliminar Actividad
                </a>
            </div>

        </div>
    </div>
</div>


@section Scripts {
    <link rel="stylesheet" href="https://uicdn.toast.com/calendar/latest/toastui-calendar.min.css">
    <script src="https://uicdn.toast.com/calendar/latest/toastui-calendar.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const events = @Html.Raw(Json.Serialize(Model.Eventos.Select(e => new
            {
                id = e.IdActividad.ToString(),
                title = e.Titulo,
                start = e.FechaCreacion,
                end= e.FechaActividad,
                color = e.Color,
                raw = e.Descripcion
            })));
            // Cambiar color si el evento ha pasado
            events.forEach(event => {
                const eventEndDate = new Date(event.end);
                const currentDate = new Date();

                // Si el evento ha pasado, cambiar el color
                if (eventEndDate < currentDate) {
                    event.color = '#d9534f'; // Color rojo para eventos pasados
                }


            });
            console.log(events);
            const container = document.getElementById('calendar');
            const options = {
                defaultView: 'month',
                useCreationPopup: false,
                useDetailPopup: false,
                taskView: false,
                timezone: {
                    zones: [
                        {
                            timezoneName: 'America/Guayaquil', // Time zone for Ecuador
                            displayLabel: 'Ecuador Time'
                        }
                    ]
                }
               
            };

            const calendar = new tui.Calendar(container, options);
            calendar.createEvents(events);

            calendar.on('clickEvent', function (eventInfo) {
                // Access the description directly from the event object, not from `raw`
                const description = eventInfo.event.raw || 'Sin descripción';

                // Convert UTC start date to Ecuador Time (America/Guayaquil)
                const eventStartDate = new Date(eventInfo.event.start);
                const eventEndDate = new Date(eventInfo.event.end);

                const ecuadorStartTime = new Date(eventStartDate.toLocaleString('en-US', { timeZone: 'America/Guayaquil' }));
                const ecuadorEndTime = new Date(eventEndDate.toLocaleString('en-US', { timeZone: 'America/Guayaquil' }));

                // Display event details in the modal
                $('#eventDetailsTitle').text(eventInfo.event.title);
                $('#eventDetailsDescription').text(description);
                $('#eventDetailsDate').text(`Fecha de inicio: ${ecuadorStartTime.toLocaleString()} (Hora Ecuador)`);
                $('#eventDetailsEndDate').text(`Fecha de fin: ${ecuadorEndTime.toLocaleString()} (Hora Ecuador)`);

                // Optionally, if you have a creation date (FechaCreacion), you can add it here
                const creationDate = eventInfo.event.raw ? new Date(eventInfo.event.raw.creationDate) : null;
                if (creationDate) {
                    const ecuadorCreationTime = new Date(creationDate.toLocaleString('en-US', { timeZone: 'America/Guayaquil' }));
                    $('#eventDetailsCreationDate').text(`Fecha de creación: ${ecuadorCreationTime.toLocaleString()} (Hora Ecuador)`);
                }

                // Establecer las URLs para los botones de editar y eliminar
                const editUrl = `/Actividades/Edit?id=${eventInfo.event.id}`;
                const deleteUrl = `/Actividades/Delete?idActividad=${eventInfo.event.id}`;

                // Asignar las URLs a los botones
                $('#editEventButton').attr('href', editUrl);
                $('#deleteEventButton').attr('href', deleteUrl);

                // Show the modal with the updated details
                $('#eventDetailsModal').modal('show');
            });


            // Manejadores para cambiar al mes anterior o siguiente
            document.getElementById('prevMonthBtn').addEventListener('click', function () {
                calendar.prev();  // Cambia al mes anterior
            });

            document.getElementById('nextMonthBtn').addEventListener('click', function () {
                calendar.next();  // Cambia al mes siguiente
            });

       



        });
    </script>
}